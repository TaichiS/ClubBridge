# 📘 ClubBridge - 跨校選社系統

一份全面性的開發指引與系統規劃文件，旨在建立一個功能強大、可擴展的多校共用線上選社系統。

---

## 📚 目錄

1.  [專案目標](#-專案目標)
2.  [技術架構](#-技術架構)
3.  [後端系統詳解](#-後端系統詳解)
    - [多租戶結構](#多租戶結構)
    - [功能模組](#功能模組)
    - [資料欄位規格](#資料欄位規格)
    - [API 路由建議](#api-路由建議)
4.  [前端系統詳解](#-前端系統詳解)
    - [目錄結構](#目錄結構)
    - [核心功能](#核心功能)
    - [狀態管理 (Pinia)](#狀態管理-pinia)
    - [路由設計 (Vue Router)](#路由設計-vue-router)
    - [UI/UX 重點](#uiux-重點)
5.  [權限管理系統](#-權限管理系統)
    - [系統架構](#系統架構)
    - [後端角色定義](#後端角色定義)
    - [前端權限狀態](#前端權限狀態)
    - [權限矩陣](#權限矩陣)
6.  [部署與維運](#-部署與維運)

---

## 📌 專案目標

1.  **多校共用**：建立一個可供多個學校獨立使用的線上選社平台。
2.  **資料隔離**：確保不同學校之間的學���、社團及報名資料完全隔離。
3.  **便捷申請**：允許任意 Google 帳號申請創建學校，並由超級管理員進行審核。
4.  **智慧登入**：社團老師使用 Google 登入後，系統能自動識別其管理的社團，方便進行點名與成績輸入。
5.  **學生專用**：學生使用「學號 + 身分證字號」即可登入選社，無需註冊或綁定 Google 帳號。
6.  **高效匯入**：支援透過 Excel 檔案批次匯入學生與社團資料。

---

## 🛠 技術架構

| 層級 | 技術 | 功能與說明 |
| :--- | :--- | :--- |
| **後端** | **Ruby on Rails (API only)** | 負責商業邏輯、RESTful API 設計。 |
| **前端** | **Vite + Vue3 + TypeScript** | 打造高效能的單頁應用程式 (SPA)。 |
| **狀態管理** | **Pinia** | 集中管理前端應用程式的狀態。 |
| **UI 框架** | **Tailwind CSS / shadcn/vue** | 使用 shadcn/vue (UI 元件)、Heroicons (圖示) 與 Motion for Vue (動畫) 打造現代化介面。 |
| **資料庫** | **MariaDB** | 支援多租戶資料儲存與高效查詢。 |
| **認證** | **Google OAuth2 / 學號+身分證** | 為不同身份提供對應的登入方式。 |
| **多租戶** | **acts_as_tenant** | 在後端實現資料隔離。 |
| **部署** | **Docker + VPS / 雲端** | 實現容器化部署，確保環境一致性。 |

---

## ⚙️ 後端系統詳解

### 多租戶結構

-   每個學校對應一個 `School` 實體，作為一個獨立的租戶。
-   透過 URL 前綴來區分不同學校的存取路徑，例如：`domain.com/schools/{school_id}/...`。
-   所有與學校相關的資料（如學生、社團、報名紀錄）都將透過 `acts_as_tenant` 與特定學校綁定。

### 功能模組

| 階段 | 功能 | 說明 |
| :--- | :--- | :--- |
| **學校申請** | 申請與審核 | 任意使用者可申請學校，由超級管理員審核，核准後申請者成為該校首位管理員。 |
| **學期初設定** | 資料匯入與維護 | 管理員可匯入學生/社團資料、設定系統公告、活動日期、維護資料等。 |
| **選社期間** | 即時監控與管理 | 管理員可查看未選社名單、即時報名統計、為特殊學生解鎖重選等。 |
| **選社結果** | 查詢與匯出 | 管理員可查詢/匯出選社結果、列印點名表、處理轉社等。 |
| **社團老師** | 點名與成績 | 老師登入後可查看自己社團的學生名單、進行點名、輸入期末成績。 |
| **學生** | 選社與查詢 | 學生登入後可填寫社團志願、並在公布後查看最終分發結果。 |

### 資料欄位規格

#### 學生資料 (10欄)

| 欄位 | 名稱 | 英文欄位 | 格式/說明 | 必填 |
| :--- | :--- | :--- | :--- | :--- |
| 1 | 年級 | `grade` | 半形數字 (國一=1, 高一=4) | ✔ |
| 2 | 班級 (數字) | `class_number` | 半形數字 (忠=1) | ✔ |
| 3 | 班級 (中文) | `class_name` | 忠/孝/仁... | ✔ |
| 4 | 座號 | `seat_number` | 半形數字 | ✔ |
| 5 | 學號 | `student_id` | 唯一識別碼 | ✔ |
| 6 | 姓名 | `name` | 中文 | ✔ |
| 7 | 身分證字號 | `id_card_number` | 作為登入密碼 | ✔ |
| 8 | 條件一 | `condition1` | 用於選社限制 (性別/部別等) | ✘ |
| 9 | 條件二 | `condition2` | 用於選社限制 (性別/部別等) | ✘ |
| 10 | 條件三 | `condition3` | 用於選社限制 (性別/部別等) | ✘ |

#### 社團資料 (13欄)

| 欄位 | 名稱 | 英文欄位 | 說明 | 必填 |
| :--- | :--- | :--- | :--- | :--- |
| 1 | 類別 | `category` | 體育/藝文等 | ✔ |
| 2 | 編號 | `club_number` | 半形數字，唯一 | ✔ |
| 3 | 社團名稱 | `name` | 中文 | ✔ |
| 4 | 指導老師 | `teacher_name` | 中文姓名 | ✔ |
| 5 | 簡介 | `description` | 最多500字 | ✔ |
| 6 | 最大人數 | `max_members` | 半形數字 | ✔ |
| 7 | 上課地點 | `location` | | ✔ |
| 8 | 雨天地點 | `rainy_day_location` | | ✘ |
| 9 | 備註 | `notes` | | ✘ |
| 10 | 條件一 | `condition1` | 限制特定學生選修 | ✘ |
| 11 | 條件二 | `condition2` | 限制特定學生選修 | ✘ |
| 12 | 條件三 | `condition3` | 限制特定學生選修 | ✘ |
| 13 | 指導老師Email | `teacher_email` | 用於老師登入識別，可空白 | ✘ |

### API 路由建議

| Method | URL | 功能 |
| :--- | :--- | :--- |
| `POST` | `/api/schools/apply` | 申請新學校 |
| `GET` | `/api/admin/schools/pending` | 查看待審核學校 |
| `POST` | `/api/admin/schools/:id/approve` | 核准學校 |
| `POST` | `/api/schools/:school_id/students/import` | 匯入學生 |
| `POST` | `/api/schools/:school_id/clubs/import` | 匯入社團 |
| `GET` | `/api/schools/:school_id/clubs/hotness_report` | 即時熱門度統計 |
| `POST` | `/api/schools/:school_id/clubs/:club_id/attendance` | 老師點名 |
| `POST` | `/api/schools/:school_id/assign` | 啟動分發 |

API設計由 swagger 管理，可以透過以下網址進行查詢：
http://localhost:5173/api-docs/index.html


---

## 🎨 前端系統詳解

### 目錄結構

```
frontend/src/
├── api/             # API 客戶端
├── assets/          # 靜態資源
├── components/      # 全域元件 (包含 shadcn/vue UI)
├── composables/     # Vue 3 組合式函數
├── layouts/         # 版面配置
├── pages/           # 頁面元件
├── router/          # Vue Router (包含路由守衛)
├── stores/          # Pinia 狀態管理
├── styles/          # 全域樣式
├── types/           # TypeScript 類型定義
└── utils/           # 工具函數
```

### 核心功能

-   **雙軌認證**：整合 Google OAuth2 (管理員/老師) 與學號+身分證 (學生) 登入流程。
-   **多租戶支援**：前端能根據 URL (`/schools/:id/...`) 動態適應不同學校的環境。
-   **響應式設計**：針對手機、平板、桌面提供優化的瀏覽體驗。

### 狀態管理 (Pinia)

透過 Pinia 將應用程式狀態模組化，主要包含：

-   `auth.ts`: 管理用戶認證、Token、角色與權限。
-   `school.ts`: 管理當前學校資訊、設定與申請列表。
-   `student.ts`: 管理學生資料、篩選條件。
-   `club.ts`: 管理社團資料、報名統計。
-   `application.ts`: 管理選社志願、分發結果。

### 路由設計 (Vue Router)

-   **公開路由**: `/`, `/apply`
-   **超級管理員**: `/admin/...`
-   **學校層級路由**: `/schools/:schoolId/...`
    -   **學校管理員**: `.../admin/...`
    -   **社團老師**: `.../teacher/...`
    -   **學生**: `.../student/...`
-   **路由守衛**: 在 `router.beforeEach` 中實現權限檢查，確保用戶只能訪問其被授權的頁面。

### UI/UX 重點

-   **學生選社介面**: 提供視覺化的志願拖拉排序功能，並有強大的社團瀏覽與篩選機制。
-   **即時統計圖表**: 使用 Chart.js 或 ECharts 實現各社團報名人數、選社進度等即時統計。
-   **Excel 匯入**: 前端使用 SheetJS 解析檔案，提供資料預覽、驗證與進度顯示。

---

## 🔐 權限管理系統

### 系統架構

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   前端 Vue3     │    │   後端 Rails    │    │   資料庫 DB     │
│                 │    │                 │    │                 │
│ Router Guards   │◄──►│ Pundit Policies │◄──►│ User Model      │
│ Pinia Store     │    │ Controller      │    │ School Model    │
│ Role Checks     │    │ Authorization   │    │ Membership      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 後端角色定義

-   **`User` Model**: 定義系統層級的角色。
    -   `super_admin`: 超級管理員，擁有全域權限。
    -   `school_admin`: 學校管理員。
    -   `teacher`: 社團老師。
-   **`Membership` Model**: 定義用戶在特定學校中的角色。
    -   `admin`: 該校的管理員。
    -   `teacher`: 該校的老師。

### 前端權限狀態

在 `stores/auth.ts` 中，透過 `computed` 屬性提供即時的權限檢查：

-   `isSuperAdmin`: 檢查是否為超級管理員。
-   `hasSchoolAccess(schoolId)`: 檢查用戶是否有權限訪問特定學校。
-   `isSchoolAdminOf(schoolId)`: 檢查用戶是否為特定學校的管理員。

### 權限矩陣

| 功能 | 超級管理員 | 學校管理員 | 社團老師 | 學生 |
| :--- | :--- | :--- | :--- | :--- |
| 查看所有學校 | ✅ | ❌ | ❌ | ❌ |
| 審核學校申請 | ✅ | ❌ | ❌ | ❌ |
| 用戶權限管理 | ✅ | ❌ | ❌ | ❌ |
| 管理**所屬**學校 | ✅ | ✅ | ❌ | ❌ |
| 學生/社團資料管理 | ✅ | ✅ | ❌ | ❌ |
| 社團點名/成績管理 | ✅ | ✅ | ✅ | ❌ |
| 選社報名 | ❌ | ❌ | ❌ | ✅ |
| 查看選社結果 | ❌ | ❌ | ❌ | ✅ |

---

## 🚀 部署與維運

-   **資料庫備份**: 每日定時備份 MariaDB 資料庫。
-   **容器化部署**: 使用 Docker 封裝應用程式，確保開發與生產環境一致。
-   **憑證管理**: 定期檢查並更新 Google OAuth 憑證與 SSL 憑證。
-   **日誌記錄**: 建立完整的操作日誌與審核日誌，方便追蹤與稽核。
-   **依賴更新**: 定期更新前後端依賴套件，確保系統安全。
