# 選社志願分發流程設計

修改的程式碼在 `app/controllers/api/club_selections_controller.rb` 裡面的 `def allocate_clubs`

## 模型規劃

### 1. ClubAllocation 模型（分發工作區）
建立一個新的分發模型 ClubAllocation，欄位與原有的 ClubSelection 模型相同：
- `student_id` - 學生ID
- `club_id` - 社團ID  
- `preference` - 志願序號 (1, 2, 3...)
- `school_id` - 學校ID（多租戶）

**用途**：分發前將舊有的 ClubSelection 內容完整搬移至此模型，作為分發演算法的工作區。
這樣反覆重新分發時不會影響原有的選社記錄。

### 2. ClubMembership 模型（分發結果）
建立社團成員模型，用以存放最終分發結果：
- `student_id` - 學生ID
- `club_id` - 社團ID
- `assigned_at` - 分配時間
- `allocation_round` - 分發輪次（1=第一志願, 2=第二志願...）
- `assignment_type` - 分配類型（special/normal/manual）
- `school_id` - 學校ID（多租戶）

## 分發程序詳細流程

### 階段一：分發前準備
1. **權限檢查**：使用 Pundit 檢查是否有管理者權限
2. **資料備份**：清空 ClubAllocation，將 ClubSelection 完整複製過來
3. **清空舊結果**：清空 ClubMembership 中本次分發的記錄
4. **社團狀態檢查**：確認所有社團都在開放狀態

### 階段二：特殊學生優先分發
4. **特殊學生分發**（`student.special = 1`）
   - 選取所有特殊學生
   - 遍歷他們的 ClubAllocation 第一志願（`preference = 1`）
   - 檢查社團條件限制（性別、年級、客製條件）
   - 通過條件檢查的學生直接分發入社，**不受人數上限限制**
   - 記錄到 ClubMembership（`assignment_type = 'special'`）
   - 從 ClubAllocation 移除已分發學生的所有記錄

**特殊學生警告機制**：
- 如果特殊學生在某社團超過該社團容量的 50%，系統發出警告
- 警告內容包含社團名稱、特殊學生人數、總容量
- 管理員可選擇繼續或調整特殊學生設定

### 階段三：一般學生多輪分發
5. **第一輪分發**（處理第一志願）
   - 遍歷每個社團，計算剩餘名額：`max_capacity - 已分發人數`
   - 選取尚未分發且第一志願是該社團的學生
   - **條件過濾**：檢查社團的條件限制
     - 條件一：性別限制（男=1, 女=2, 無限制=0）
     - 條件二：學制限制（高中=1, 國中=2, 無限制=0）  
     - 條件三：客製條件
   - **分發邏輯**：
     - 如果符合條件的學生數 ≤ 剩餘名額：全部分發
     - 如果符合條件的學生數 > 剩餘名額：隨機選取分發
   - 記錄到 ClubMembership（`assignment_type = 'normal'`, `allocation_round = 1`）

6. **志願序整理**
   - 將滿額社團從所有學生的 ClubAllocation 中移除
   - 重新整理志願序號：後續志願向前遞補
   - 例：原本 1→籃球 2→足球 3→桌球，籃球滿額後變成 1→足球 2→桌球

7. **後續輪次分發**
   - 重複步驟5-6，處理第2、3、4...志願
   - 直到滿足終止條件

### 階段四：終止條件與收尾
8. **分發終止條件**（滿足任一條件即停止）
   - 所有學生都已分配到社團
   - 所有開放的社團都已額滿  
   - 剩餘未分配學生沒有任何可選的社團（所有志願都不符合條件或已滿額）
   - 達到最大分發輪次限制（預設10輪，防止無窮迴圈）

9. **未分配學生處理**
   - 產生「衰運學生」清單
   - 提供管理員後續處理選項：
     - 手動分配到有空位的社團
     - 開設新社團
     - 調整現有社團容量
     - 等待學生修改志願重新分發

### 階段五：分發日誌與驗證
10. **分發日誌記錄**
    - 記錄每輪分發的詳細過程
    - 包含：分發時間、社團狀況、學生分配結果、隨機選取的種子值
    - 便於問題追蹤與分發過程驗證

11. **結果驗證**
    - 檢查是否有學生重複分配
    - 檢查社團人數是否超過上限（特殊學生除外）
    - 驗證所有分配都符合社團條件限制

## 邊界情況處理

### 1. 志願序不完整
- 學生沒有填滿所有志願：正常處理，以填寫的志願為準
- 學生完全沒有志願：加入未分配學生清單

### 2. 社團條件衝突
- 學生條件不符合志願社團：該志願無效，跳過處理
- 在志願序整理時一併移除無效志願

### 3. 社團最低人數限制
- 分發完成後檢查社團人數是否達到最低標準
- 未達標的社團標記為「人數不足」，可能需要廢社處理
- 提供管理員介面處理廢社學生的重新分配

### 4. 資料一致性
- 使用資料庫交易確保分發過程的原子性
- 分發過程中如有錯誤，回滾所有變更

### 5. 並發處理
- 分發期間鎖定相關資料表，防止同時修改
- 提供分發狀態標記，防止重複執行

## 演算法複雜度與效能
- 時間複雜度：O(輪次 × 社團數 × 學生數)
- 空間複雜度：O(學生數 × 平均志願數)
- 建議在資料量大時加入進度顯示與分批處理機制


